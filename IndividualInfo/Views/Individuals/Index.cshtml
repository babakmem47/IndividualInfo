@using IndividualInfo.ViewModels
@{
    ViewBag.Title = "اسامی افراد";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col-lg-1 col-xs-1"></div>
    <div class="col-lg-10 col-xs-10" align="center">
        <h2>لیست افراد</h2>
    </div>
    <div class="col-lg-1 col-xs-1"></div>
</div>

<div class="row">
    <div class="col-lg-1 col-xs-1">
        @Html.ActionLink("+", "New", "Individuals", null, new { @class = "btn btn-primary btn-lg", title = "افزودن فرد جدید" })

    </div>
    <div class="col-lg-10 col-xs-10" align="right">
    </div>
    <div class="col-lg-1 col-xs-1"></div>
</div>

<div class="row voffset2">
    @*<div class="col-lg-1 col-xs-1"></div>*@
    <div class="col-lg-12 col-xs-12">
        <table id="individualTable" class="table table-bordered table-hover table-striped table-condensed table-responsive">
            <thead>
                <tr>
                    <td>ردیف</td>
                    <td>نام</td>
                    <td>سمت</td>
                    <td><i class="fa fa-intersex" style="font-size:16px"></i></td>
                    <td> مستقیم &nbsp; <span class="glyphicon glyphicon-phone-alt"></span></td>
                    <td> داخلی &nbsp;<span class="glyphicon glyphicon-earphone"></span></td>
                    <td> موبایل &nbsp;<span class="glyphicon glyphicon-phone"></span></td>
                    <td>توضیحات</td>
                    <td class="fontsize9">ویرایش | حذف</td>
                </tr>
            </thead>

            <tbody></tbody>
        </table>
    </div>
    @*<div class="col-lg-1 col-xs-1"></div>*@
</div>

<!-- Modal -->
<div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">ویرایش</h4>
            </div>
            <div class="modal-body">
                @using (Html.BeginForm("Save", "Individuals", FormMethod.Post, new { @class = "form-inline" }))
                {
                    <div class="row">
                        <div class="form-group form-inline width22pc">
                            <label for="Name">نام</label>
                            <input class="form-control" data-val="true" data-val-maxlength="حداکثر 70 کاراکتر"
                                   data-val-maxlength-max="70" data-val-required="پر کردن فیلد نام ضروری است"
                                   id="Name" name="Name" type="text" value="" />
                            <span class="field-validation-valid" data-valmsg-for="Name" data-valmsg-replace="true"></span>
                        </div>
                        <div class="form-group form-inline width15pc">
                            <label for="SematId">سِمَت</label>
                            <select class="form-control" data-val="true" data-val-number="The field سِمَت must be a number." id="SematId" name="SematId">
                                <option value=""></option>
                                <option value="1">کارشناس</option>
                                <option value="2">کاربر رایانه</option>
                                <option value="3">معاون دایره</option>
                                <option value="4">رئیس دایره</option>
                                <option value="5">متصدی امور بانکی</option>
                                <option value="6">اپراتور</option>
                                <option value="7">پیش خدمت</option>
                                <option value="8">معاون اداره</option>
                                <option value="9">رئیس اداره</option>
                                <option value="10">کارمند</option>
                                <option value="11">رابط</option>
                                <option value="12">غیره</option>
                                <option value="13">رئیس خدمات ماشینی</option>
                                <option value="14">مسئول خدمات ماشینی</option>
                                <option value="15">معاون خدمات ماشینی</option>
                                <option value="16">خدمات ماشینی</option>
                            </select>
                            <span class="field-validation-valid" data-valmsg-for="SematId" data-valmsg-replace="true"></span>
                        </div>
                        <div class="form-group form-inline width5pc">
                            <label for="Gender">جنسیت</label>
                            <select class="form-control" id="Gender" name="Gender">
                                <option value=""></option>
                                <option value="true">زن</option>
                                <option value="false">مرد</option>
                            </select>
                            <span class="field-validation-valid" data-valmsg-for="Gender" data-valmsg-replace="true"></span>
                        </div>
                        <div class="form-group form-inline width10pc">
                            <label for="TelDirect">تلفن مستقیم</label>
                            <input class="form-control" data-val="true" data-val-maxlength="حداکثر 50 کاراکتر" data-val-maxlength-max="50" id="TelDirect" name="TelDirect" type="text" value="" />
                            <span class="field-validation-valid" data-valmsg-for="TelDirect" data-valmsg-replace="true"></span>
                        </div>
                        <div class="form-group form-inline width5pc">
                            <label for="TelDakheli"> داخلی</label>
                            <input class="form-control" data-val="true" data-val-maxlength="حداکثر 40 کاراکتر" data-val-maxlength-max="40" id="TelDakheli" name="TelDakheli" type="text" value="" />
                            <span class="field-validation-valid" data-valmsg-for="TelDakheli" data-valmsg-replace="true"></span>
                        </div>
                        <div class="form-group form-inline width12pc">
                            <label for="Mobile">موبایل</label>
                            <input class="form-control" data-val="true" data-val-maxlength="حداکثر 50 کاراکتر" data-val-maxlength-max="50" id="Mobile" name="Mobile" type="text" value="" />
                            <span class="field-validation-valid" data-valmsg-for="Mobile" data-valmsg-replace="true"></span>
                        </div>
                        <div class="form-group form-inline width28pc">
                            <label for="Description">توضیحات</label>
                            <input class="form-control" data-val="true" data-val-maxlength="حداکثر 250 کاراکتر" data-val-maxlength-max="250" id="Description" name="Description" type="text" value="" />
                            <span class="field-validation-valid" data-valmsg-for="Description" data-valmsg-replace="true"></span>
                        </div>

                    </div>

                    <br />
                    <br />
                    <br />
                    <input data-val="true" data-val-number="The field Id must be a number."
                           data-val-required="The Id field is required." id="Id" name="Id" type="hidden" value="4" />
                    @Html.AntiForgeryToken()
                    <button id="savebutton" type="submit" class="btn btn-primary">ذخیره</button>
                }
            </div>
            @*<div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>*@
        </div>

    </div>
</div>
<!-- End of Modal -->
@section scripts
{
    @Scripts.Render("~/bundles/jqueryval")


    @*<script src='https://kit.fontawesome.com/a076d05399.js'></script>*@
    <script>
        $(document).ready(function () {
            $(".table").persiaNumber();

            var individualTable = $("#individualTable");
            var row = 1;

            individualTable.DataTable({
                "pageLength": 20,

                "oLanguage": {
                    "sSearch": "جستجو  ",
                    "sSearchPlaceholder": "یه چیزی بنویس ...",
                    "sLengthMenu": "نمایش  _MENU_  رکورد در جدول",
                    "decimal": "",
                    "sEmptyTable": "هیچ داده قابل دسترسی در جدول یافت نشد",
                    "sInfo": "نمایش _START_ تا _END_ از _TOTAL_ ورودی",
                    "sInfoEmpty": "نمایش 0 تا 0 از صفر ورودی",
                    "sInfoFiltered": "(فیلتر شده از _MAX_ کل ورودی ها)",
                    "infoPostFix": "",
                    "thousands": ",",
                    "sLoadingRecords": "بارگذاری ...",
                    "sProcessing": "پردازش ...",
                    "sZeroRecords": "هیچ رکوردی که مطابقت داشته باشد یافت نشد",
                    "oPaginate": {
                        "sFirst": "اول",
                        "sLast": "آخر",
                        "sNext": "بعدی",
                        "sPrevious": "قبلی"
                    }
                },

                "sDom":
                    "<'row'<'col-sm-6'f><'col-sm-6'l>>" +
                        "<'row'<'col-sm-12'tr>>" +
                        "<'row'<'col-sm-5'i><'col-sm-7'p>>",

                "columnDefs": [
                    { "className": "text-center", "targets": "_all" }
                ],

                ajax: {
                    url: "/api/individuals",
                    dataSrc: ""
                },

                columns: [
                    {
                        data: "",
                        orderable: false,
                        className: "width30px",
                        //searchable: false,
                        //sortable: false,
                        render: function () {
                            return row++;
                        }
                    },
                    {
                        data: "name"
                    },
                    {
                        data: "sematDto.id",
                        render: function (data, type, individual) {
                            if (data !== 0)
                                return individual.sematDto.name;
                            else
                                return '';
                        }
                    },
                    {
                        orderable: false,
                        data: "gender",
                        render: function (data) {
                            if (data === true)
                                return "<td><i class='fa fa-female' style='font-size:14px;'></i></td>";
                            else if (data === false)
                                return "<td><i class='fa fa-male' style='font-size:14px;'></i></td>";
                            else
                                return '';
                        }
                    },
                    {
                        data: "telDirect",
                        className: "width65px"
                    },
                    {
                        data: "telDakheli",
                        className: "width65px"
                    },
                    {
                        orderable: false,
                        className: "ltrcell width100px",
                        data: "mobile"
                    },
                    {
                        data: "description"
                    },
                    {
                        orderable: false,
                        className: "text-left EditRemoveColumn",
                        data: "id",
                        render: function (data) {
                            return "<a href='/Individuals/Edit/" +
                                data +
                                "'> " +
                                "<span class='glyphicon glyphicon-edit' title='... ویرایش'</span></a>" +
                                "&nbsp;" +
                                "<a href='' class='link-open-edit-modal' data-toggle='modal' data-target='#myModal' data-individual-id='" +
                                data +"'><span class='glyphicon glyphicon-edit' title='... ویرایش'></span></a>" +
                                "&nbsp;&nbsp;" +
                                "<button class='btn-link js-delete' data-person-id='" +
                                data +
                                "'> " +
                                "<span class='glyphicon glyphicon-remove' title='حذف'</span></button>";
                        }
                    }
                ]
            });

            individualTable.on("click", ".js-delete",
                function () {
                    var delButton = $(this);
                    var delbtn = this;
                    console.log(delButton.closest("tr").attr);
                    //console.log(delbtn.parent("tr"));
                    var dialog = bootbox.dialog({
                        title: 'تائید',
                        message: "آیا مطمئن هستید که می خواهید رکورد " + " '" + +  "' " + "حذف شود؟",
                        buttons: {
                            yes: {
                                label: "حذف",
                                className: 'btn-danger pull-left',
                                callback: function () {
                                    $.ajax({
                                        url: "/api/individuals/" + delButton.attr("data-person-id"),
                                        method: "DELETE"
                                    })
                                        .done(function () {
                                            var rowToBeDelete = delButton.parents("tr");
                                            rowToBeDelete.fadeOut(200,
                                                function () {
                                                    table.row(rowToBeDelete).remove().draw();
                                                });
                                        })
                                        .fail(function () {
                                            alert("Something failed");
                                        });
                                }
                            },
                            no: {
                                label: "خیر",
                                className: 'btn-default btn-left-bootbox',
                                callback: function () {
                                    bootbox.hideAll();
                                }
                            }
                        }
                    });
                });

            individualTable.on("click",
                ".link-open-edit-modal",
                function() {
                    var editButton = $(this);
                    console.log(editButton.attr("data-individual-id"));
                    $.ajax({
                        url: "/api/individuals/" + editButton.attr("data-individual-id"),
                        method: "GET"
                    }).done(function(data, status) {
                        $("#Name").val(data.name);

                    }).fail(function(status) {
                        alert("fail to real data");
                        console.log(status);
                    });

                });

            // hide validatin error when modal closed: because the error msg remain for other records when clicking on edit
            $("#myModal").on('hidden.bs.modal',
                function (e) {
                    console.log("modal closed");
                    $(".form-group > span").removeClass("field-validation-error").children("span").remove();
                    $(".form-group > .form-control").removeClass("input-validation-error");
                });


            // remove(hide) sorting icon on first column
            $(window).load(function () {
                $('.sorting_asc').removeClass('sorting_asc');
                $("#myModal").on('shown.bs.modal',
                    function() {
                        //$(".form-group > span").addClass('newline');
                        $(".form-group > span").css("display", "block");
                    });
            });

            
        });
    </script>

}
